/* 
 * Copyright (c) 2020 Peter J. Philipp
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */
/*
 * This code generates MATCHES and MASKS for RISC-V opcodes based on
 * https://github.com/freebsd/freebsd/blob/master/sys/riscv/include/encoding.h
 * but made by hand thus losing the copyright.  This implementation also
 * differs in that it gathers all masks first and then writes defines.
 * This implementation lacks the C extension set (compressed) because for
 * the scope of the work this will be used, it's not needed.
 * risc-v IMAFD implementation based out of the book:
 * The RISC-V Reader by David Patterson and Andrew Waterman.
 */

#include <sys/types.h>
#include <sys/queue.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#include <errno.h>

/* inspired by FreeBSD's impl. */

char * getmask(int j);

SLIST_HEAD(,masks) maskhead;

struct masks {
	char *mask;
	int compressed;
	SLIST_ENTRY(masks) entries;
} *n1, *n2, *np;

struct op {
	char *opcode;
	char *code;
	char *mask;
	int masklen;
};

#if notyet
/* The RISC-V Reader - page 69, and opcode index */
struct op_rv32C_op[] = {
	{ "c.nop", "0000000000000001", "1110011111000011", 16 },
	{ "c.add", "0000000000000000", "0000000000000000", 16 },
	{ "c.addi", "0000000000000000", "1110000000000011", 16 },
	{ "c.addi16sp", "0000000000000000", "0000000000000000", 16 },
	{ "c.addi4spn", "0000000000000000", "0000000000000000", 16 },
	{ "c.addiw", "0000000000000000", "0000000000000000", 16 },
	{ "c.and", "0000000000000000", "0000000000000000", 16 },
	{ "c.addw", "0000000000000000", "0000000000000000", 16 },
	{ "c.andi", "0000000000000000", "0000000000000000", 16 },
	{ "c.beqz", "0000000000000000", "0000000000000000", 16 },
	{ "c.bnez", "0000000000000000", "0000000000000000", 16 },
	{ "c.ebreak", "0000000000000000", "0000000000000000", 16 },
	{ "c.fld", "0000000000000000", "0000000000000000", 16 },
	{ "c.fldsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.flw", "0000000000000000", "0000000000000000", 16 },
	{ "c.flwsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.fsd", "0000000000000000", "0000000000000000", 16 },
	{ "c.fsdsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.fsw", "0000000000000000", "0000000000000000", 16 },
	{ "c.fswsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.j", "0000000000000000", "0000000000000000", 16 },
	{ "c.jal", "0000000000000000", "0000000000000000", 16 },
	{ "c.jalr", "0000000000000000", "0000000000000000", 16 },
	{ "c.jr", "0000000000000000", "0000000000000000", 16 },
	{ "c.ld", "0000000000000000", "0000000000000000", 16 },
	{ "c.ldsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.li", "0000000000000000", "0000000000000000", 16 },
	{ "c.lui", "0000000000000000", "0000000000000000", 16 },
	{ "c.lw", "0000000000000000", "0000000000000000", 16 },
	{ "c.lwsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.mv", "0000000000000000", "0000000000000000", 16 },
	{ "c.or", "0000000000000000", "0000000000000000", 16 },
	{ "c.sd", "0000000000000000", "0000000000000000", 16 },
	{ "c.sdsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.slli", "0000000000000000", "0000000000000000", 16 },
	{ "c.srai", "0000000000000000", "0000000000000000", 16 },
	{ "c.srli", "0000000000000000", "0000000000000000", 16 },
	{ "c.sub", "0000000000000000", "0000000000000000", 16 },
	{ "c.subw", "0000000000000000", "0000000000000000", 16 },
	{ "c.sw", "0000000000000000", "0000000000000000", 16 },
	{ "c.swsp", "0000000000000000", "0000000000000000", 16 },
	{ "c.xor", "0000000000000000", "0000000000000000", 16 },
	{ "c.slli64", "0000000000000000", "0000000000000000", 16 },
	{ NULL, NULL, NULL, 0 }
};
#endif

struct op rv32I_op[] = {
	/* RV32I STANDARD OPCODES "The RISC-V Reader page 16 */
	{ "lui", 	"00000000000000000000000000110111", 
			"00000000000000000000000001111111", 32 },
	{ "auipc", 	"00000000000000000000000000010111", 
			"00000000000000000000000001111111", 32 },
	{ "jal",	"00000000000000000000000001101111", 
			"00000000000000000000000001111111", 32 },
	{ "jalr", 	"00000000000000000000000001100111",
		   	"00000000000000000111000001111111" , 32},
	
	{ "beq", 	"00000000000000000000000001100011",
		   	"00000000000000000111000001111111" , 32},

	{ "bne",	"00000000000000000001000001100011",
		   	"00000000000000000111000001111111" , 32},

	{ "blt",	"00000000000000000100000001100011",
		   	"00000000000000000111000001111111" , 32},

	{ "bge",	"00000000000000000101000001100011",
		   	"00000000000000000111000001111111" , 32},

	{ "bltu",	"00000000000000000110000001100011",
		   	"00000000000000000111000001111111" , 32},

	{ "bgeu",	"00000000000000000111000001100011",
		   	"00000000000000000111000001111111" , 32},
	
	{ "lb",		"00000000000000000000000000000011",
		   	"00000000000000000111000001111111" , 32},

	{ "lh",		"00000000000000000001000000000011",
		   	"00000000000000000111000001111111" , 32},

	{ "lhu",	"00000000000000000101000000000011",
		   	"00000000000000000111000001111111" , 32},

	{ "lw",		"00000000000000000010000000000011",
		   	"00000000000000000111000001111111" , 32},

	{ "lbu",	"00000000000000000100000000000011",
		   	"00000000000000000111000001111111" , 32},

	{ "sb",		"00000000000000000000000000100011",
		   	"00000000000000000111000001111111" , 32},

	{ "sh",		"00000000000000000001000000100011",
		   	"00000000000000000111000001111111" , 32},
	
	{ "sw", 	"00000000000000000010000000100011",
		   	"00000000000000000111000001111111" , 32},

	{ "addi", 	"00000000000000000000000000010011",
		   	"00000000000000000111000001111111" , 32},

	{ "slti", 	"00000000000000000010000000010011",
		   	"00000000000000000111000001111111" , 32},

	{ "sltiu", 	"00000000000000000011000000010011",
		   	"00000000000000000111000001111111" , 32},

	{ "xori", 	"00000000000000000100000000010011",
		   	"00000000000000000111000001111111" , 32},

	{ "ori", 	"00000000000000000110000000010011",
		   	"00000000000000000111000001111111" , 32},

	{ "andi", 	"00000000000000000111000000010011",
		   	"00000000000000000111000001111111" , 32},

#if RV32I
	{ "slli", 	"00000000000000000001000000010011",
		   	"11111110000000000111000001111111" , 32},

	{ "srli", 	"00000000000000000101000000010011",
		   	"11111110000000000111000001111111" , 32},

	{ "srai", 	"01000000000000000101000000010011",
		   	"11111110000000000111000001111111" , 32},
#endif

	{ "add", 	"00000000000000000000000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "sub", 	"01000000000000000000000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "sll", 	"00000000000000000001000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "slt", 	"00000000000000000010000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "sltu", 	"00000000000000000011000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "xor", 	"00000000000000000100000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "srl", 	"00000000000000000101000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "sra", 	"01000000000000000101000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "or", 	"00000000000000000110000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "and", 	"00000000000000000111000000110011",
		   	"11111110000000000111000001111111" , 32},

	{ "fence", 	"00000000000000000000000000001111",
		   	"11110000000111111111111111111111" , 32},

	{ "fence.i", 	"00000000000000000001000000001111",
		   	"11111111111111111111111111111111" , 32},

	{ "wfi", 	"00010000010100000000000001110011",
		   	"11111111111111111111111111111111" , 32},


	{ "sfence.vma", "00010010000000000000000011100111",
		   	"11111110000000000111111111111111" , 32},


	{ "ecall", 	"00000000000000000000000001110011",
		   	"11111111111111111111111111111111" , 32},

	{ "ebreak", 	"00000000000100000000000001110011",
		   	"11111111111111111111111111111111" , 32},

	{ "csrrw", 	"00000000000000000001000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "csrrs", 	"00000000000000000010000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "csrrc", 	"00000000000000000011000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "csrrwi", 	"00000000000000000101000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "csrrsi", 	"00000000000000000110000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "csrrci", 	"00000000000000000111000001110011",
		   	"00000000000000000111000001111111" , 32},

	{ "sret", 	"00010000001000000000000001110011",
			"11111111111111111111111111111111", 32},

	{ "mret", 	"00110000001000000000000001110011",
			"11111111111111111111111111111111", 32},


	{ NULL, NULL, NULL, 0 }
};

struct op rv32M_op[] = {
	{ "mul",  "00000010000000000000000000110011", 
		  "11111110000000000111000001111111", 32 },

	{ "mulh", "00000010000000000001000000110011", 
		  "11111110000000000111000001111111", 32 },

	{ "mulhsu", 	"00000010000000000010000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ "mulhu", 	"00000010000000000011000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ "div", 	"00000010000000000100000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ "divu", 	"00000010000000000101000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ "rem", 	"00000010000000000110000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ "remu", 	"00000010000000000111000000110011", 
		  	"11111110000000000111000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv32A_op[] = {
	{ "lr.w", 	"00010000000000000010000000101111", 
		  	"11111001111100000111000001111111", 32 },

	{ "sc.w", 	"00011000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoswap.w", 	"00001000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoadd.w", 	"00000000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoxor.w", 	"00100000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoand.w", 	"01100000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoor.w", 	"01000000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomin.w", 	"10000000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomax.w", 	"10100000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amominu.w", 	"11000000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomaxu.w", 	"11100000000000000010000000101111", 
		  	"11111000000000000111000001111111", 32 },

	
	{ NULL, NULL, NULL, 0 }
};

struct op rv32D_op[] = {
	{ "fld", 	"00000000000000000011000000000111", 
		  	"00000000000000000111000001111111", 32 },

	{ "fsd", 	"00000000000000000011000000100111", 
		  	"00000000000000000111000001111111", 32 },

	{ "fmadd.d", 	"00000000000000000000000001000011", 
		  	"00000110000000000000000001111111", 32 },

	{ "fmsub.d", 	"00000000000000000000000001000111", 
		  	"00000110000000000000000001111111", 32 },

	{ "fnmsub.d", 	"00000000000000000000000001001011", 
		  	"00000110000000000000000001111111", 32 },

	{ "fnmadd.d", 	"00000000000000000000000001001111", 
		  	"00000110000000000000000001111111", 32 },

	{ "fadd.d", 	"00000010000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fsub.d", 	"00001010000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fmul.d", 	"00010010000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fdiv.d", 	"00011010000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fsqrt.d", 	"01011010000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fsgnj.d", 	"00100010000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fsgnjn.d", 	"00100010000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fsgnjx.d", 	"00100010000000000010000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fmin.d", 	"00101010000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fmax.d", 	"00101010000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fcvt.s.d", 	"01000000000100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.d.s", 	"01000010000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "feq.d", 	"10100010000000000010000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "flt.d", 	"10100010000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fle.d", 	"10100010000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fclass.d", 	"11100010000000000001000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ "fcvt.w.d", 	"11000010000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.wu.d", 	"11000010000100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.d.w", 	"11010010000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.d.wu", 	"11010010000100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv32F_op[] = {
	{ "flw", 	"00000000000000000010000000000111", 
		  	"00000000000000000111000001111111", 32 },

	{ "fsw", 	"00000000000000000010000000100111", 
		  	"00000000000000000111000001111111", 32 },

	{ "fmadd.s", 	"00000000000000000000000001000011", 
		  	"00001100000000000000000001111111", 32 },

	{ "fmsub.s", 	"00000000000000000000000001000111", 
		  	"00001100000000000000000001111111", 32 },

	{ "fnmsub.s", 	"00000000000000000000000001001011", 
		  	"00001100000000000000000001111111", 32 },

	{ "fnmadd.s", 	"00000000000000000000000001001111", 
		  	"00001100000000000000000001111111", 32 },

	{ "fadd.s", 	"00000000000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fsub.s", 	"00001000000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fmul.s", 	"00010000000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fdiv.s", 	"00011000000000000000000001010011", 
		  	"11111110000000000000000001111111", 32 },

	{ "fsqrt.s", 	"01011000000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fsgnj.s", 	"00100000000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fsgnjn.s", 	"00100000000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fsgnjx.s", 	"00100000000000000010000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fmin.s", 	"00101000000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fmax.s", 	"00101000000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fmax.s", 	"00101000000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fcvt.w.s", 	"11000000000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.wu.s", 	"11000000000100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fmv.x.w", 	"11100000000000000000000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ "feq.s", 	"10100000000000000010000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "flt.s", 	"10100000000000000001000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fle.s", 	"10100000000000000000000001010011", 
		  	"11111110000000000111000001111111", 32 },

	{ "fclass.s", 	"11100000000000000001000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ "fcvt.s.w", 	"11010000000000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.s.wu", 	"11010000000100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fmv.w.x", 	"11110000000000000000000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv64D_op[] = {
	{ "fcvt.l.d", 	"11000010001000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.lu.d", 	"11000010001100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fmv.x.d", 	"11100010000000000000000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ "fcvt.d.l", 	"11010010001000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.d.lu", 	"11010010001100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fmv.d.x", 	"11110010000000000000000001010011", 
		  	"11111111111100000111000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv64F_op[] = {
	{ "fcvt.l.s", 	"11000000001000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.lu.s", 	"11000000001100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.s.l", 	"11010000001000000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ "fcvt.s.lu", 	"11010000001100000000000001010011", 
		  	"11111111111100000000000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};


/*
 * The below is converted from FreeBSD but found in 
 *   https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf
 *   chapter 10.
 */

struct op rv64Q_op[] = {
	{ "uret"	,"00000000001000000000000001110011",
			"11111111111111111111111111111111", 32},
	{ "dret"	,"01111011001000000000000001110011",
			"11111111111111111111111111111111", 32},
	{ "fadd.q"	,"00000110000000000000000001010011",
			"11111110000000000000000001111111", 32},
	{ "fsub.q"	,"00001110000000000000000001010011",
			"11111110000000000000000001111111", 32},
	{ "fmul.q"	,"00010110000000000000000001010011",
			"11111110000000000000000001111111", 32},
	{ "fdiv.q"	,"00011110000000000000000001010011",
			"11111110000000000000000001111111", 32},
	{ "fsgnj.q"	,"00100110000000000000000001010011",
			"11111110000000000111000001111111", 32},
	{ "fsgnjn.q"	,"00100110000000000001000001010011",
			"11111110000000000111000001111111", 32},
	{ "fsgnjx.q"	,"00100110000000000010000001010011",
			"11111110000000000111000001111111", 32},
	{ "fmin.q"	,"00101110000000000000000001010011",
			"11111110000000000111000001111111", 32},
	{ "fmax.q"	,"00101110000000000001000001010011",
			"11111110000000000111000001111111", 32},
	{ "fcvt.s.q"	,"01000000001100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.q.s"	,"01000110000000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.d.q"	,"01000010001100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.q.d"	,"01000110000100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fsqrt.q"	,"01011110000000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fle.q"	,"10100110000000000000000001010011",
			"11111110000000000111000001111111", 32},
	{ "flt.q"	,"10100110000000000001000001010011",
			"11111110000000000111000001111111", 32},
	{ "feq.q"	,"10100110000000000010000001010011",
			"11111110000000000111000001111111", 32},
	{ "fcvt.w.q"	,"11000110000000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.wu.q"	,"11000110000100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.l.q"	,"11000110001000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.lu.q"	,"11000110001100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fmv.x.q"	,"11100110000000000000000001010011",
			"11111111111100000111000001111111", 32},
	{ "fclass.q"	,"11100110000000000001000001010011",
			"11111111111100000111000001111111", 32},
	{ "fcvt.q.w"	,"11010110000000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.q.wu"	,"11010110000100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.q.l"	,"11010110001000000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fcvt.q.lu"	,"11010110001100000000000001010011",
			"11111111111100000000000001111111", 32},
	{ "fmv.q.x"	,"11110110000000000000000001010011",
			"11111111111100000111000001111111", 32},
	{ "flq"	,"00000000000000000100000000000111",
			"00000000000000000111000001111111", 32},
	{ "fsq"	,"00000000000000000100000000100111",
			"00000000000000000111000001111111", 32},
	{ "fmadd.q"	,"00000110000000000000000001000011",
			"00000110000000000000000001111111", 32},
	{ "fmsub.q"	,"00000110000000000000000001000111",
			"00000110000000000000000001111111", 32},
	{ "fnmsub.q"	,"00000110000000000000000001001011",
			"00000110000000000000000001111111", 32},
	{ "fnmadd.q"	,"00000110000000000000000001001111",
			"00000110000000000000000001111111", 32},

	{ NULL, NULL, NULL, 0 }
};

struct op rv64A_op[] = {
	{ "lr.d", 	"00010000000000000011000000101111", 
		  	"11111001111100000111000001111111", 32 },

	{ "sc.d", 	"00011000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoswap.d", 	"00001000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoadd.d", 	"00000000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoxor.d", 	"00100000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoand.d", 	"01100000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amoor.d", 	"01000000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomin.d", 	"10000000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomax.d", 	"10100000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomax.d", 	"10100000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amominu.d", 	"11000000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ "amomaxu.d", 	"11100000000000000011000000101111", 
		  	"11111000000000000111000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv64M_op[] = {
	{ "mulw",  "00000010000000000000000000111011", 
		  "11111110000000000111000001111111", 32 },

	{ "divw", "00000010000000000100000000111011", 
		  "11111110000000000111000001111111", 32 },

	{ "divuw", 	"00000010000000000101000000111011", 
		  	"11111110000000000111000001111111", 32 },

	{ "remw", 	"00000010000000000110000000111011", 
		  	"11111110000000000111000001111111", 32 },

	{ "remuw", 	"00000010000000000111000000111011", 
		  	"11111110000000000111000001111111", 32 },

	{ NULL, NULL, NULL, 0 }
};

struct op rv64I_op[] = {
	/* RV64I STANDARD EXTENSION "The RISC-V Reader page 89" */
	{ "lwu", "00000000000000000110000000000011", 
		 "00000000000000000111000001111111", 32 },
	{ "ld",	 "00000000000000000011000000000011", 
		 "00000000000000000111000001111111" , 32},
	{ "sd",  "00000000000000000011000000100011", 
		 "00000000000000000111000001111111" , 32},
	{ "slli", "00000000000000000001000000010011", 
		  "11111100000000000111000001111111", 32 },	/* RV64I 1.9 */
	{ "srli", "00000000000000000101000000010011",
		  "11111100000000000111000001111111", 32 },
	{ "srai", "01000000000000000101000000010011",
		  "11111100000000000111000001111111", 32 },
	{ "addiw", "00000000000000000000000000011011", 
		"00000000000000000111000001111111", 32 },
	{ "slliw", "00000000000000000001000000011011", 
		   "11111110000000000111000001111111" , 32},
	{ "srliw", "00000000000000000101000000011011", 
		   "11111110000000000111000001111111", 32 },
	{ "sraiw", "01000000000000000101000000011011", 
		   "11111110000000000111000001111111", 32 },
	{ "addw",  "00000000000000000000000000111011", 
		   "11111110000000000111000001111111" , 32},
	{ "subw",  "01000000000000000000000000111011", 
		   "11111110000000000111000001111111" , 32},
	{ "sllw",  "00000000000000000001000000111011", 
		   "11111110000000000111000001111111", 32 },
	{ "srlw",  "00000000000000000101000000111011", 
		   "11111110000000000111000001111111", 32 },
	{ "sraw",  "01000000000000000101000000111011", 
		   "11111110000000000111000001111111", 32 },
		
	{ NULL, NULL, NULL, 0 }
};

struct op test[] = {
	{ "test",  "11111111111111111111111111111111", 
			"11111111111111111111111111111111", 32},
	{ NULL, NULL, NULL, 0 }
};

#define SET_OP_CODES(strct, set)		&(strct ## set ## _op)[0]
#define MASK(j)					getmask(j)

#define GATHER_OPMASKS() 	do {		\
	for (; pop->code != NULL; pop++) {	\
		SLIST_FOREACH(np, &maskhead, entries) { \
			if (strcmp(np->mask, pop->mask) == 0)	\
				break;				\
		}	\
		if (np == NULL) {	\
			n1 = malloc(sizeof(struct masks));	\
			if (n1 == NULL) {			\
				fprintf(stderr, "malloc: %s\n", strerror(errno));	\
				exit(1);	\
			}	\
			n1->mask = strdup(pop->mask);	\
			if (n1->mask == NULL) {	\
				fprintf(stderr, "malloc2: %s\n", strerror(errno));	\
				exit(1);	\
			}	\
			SLIST_INSERT_HEAD(&maskhead, n1, entries); \
		}	\
	}	\
} while(0);

#define OP_CODES() 	do {			\
	for (; pop->code != NULL; pop++) {	\
		if (strlen(pop->code) != strlen(pop->mask)) {	\
			fprintf(stderr, "error entry %d\n", i);	 \
			exit(1);				\
		}						\
		if (strlen(pop->mask) != pop->masklen) {	\
			fprintf(stderr, "error entry %d - masklen\n", i); \
			exit(1);				\
		}						\
		j = 0;	 \
		SLIST_FOREACH(np, &maskhead, entries) {	\
			if (strcmp(pop->mask, np->mask) == 0)		\
				break;	\
			j++;	\
		}	\
		uppercs = uppercase(pop->opcode);		\
		snprintf(tmp, sizeof(tmp), "RV64%c_%s_OPCODE", set, uppercs); \
		printf("#define %-20s\t0x%s\t/* %s */\n", tmp, hex(pop->code), pop->opcode);	\
		printf("\t{ \"%s\", RV64%c_%s_OPCODE, %s },\n", \
			pop->opcode, set, uppercs, MASK(j));	\
		free(uppercs);	\
	}	\
} while (0);


char *
uppercase(char *input)
{
	char *ret, *p;
	ret = strdup(input);
	if (ret == NULL)
		return NULL;

	for (p = ret; *p != '\0'; p++) {
		if (*p == '.')
			*p = '_';
		else 
			*p = toupper(*p);	
	}

	return (ret);
}

char *
hex(char *input)
{
	static char ret[9];
	char *p;
	uint32_t shift = 0;
	uint32_t val;
	
	for (p = input, val = 0, shift = 31; shift >= 0 && *p != '\0'; shift--) {
		if (*p++ == '1')
			val += (1 << shift);
	}

	snprintf(ret, sizeof(ret), "%08X", val);

	return (&ret[0]);
}

char *
getmask(int j)
{
	static char tmp[80];

	snprintf(tmp, sizeof(tmp), "RV64_MASK%d", j);
	
	return (&tmp[0]);
}

int
main(void)
{
	struct op *pop = &test[0];
	char *uppercs;
	char tmp[80];
	int i = 1;
	int j;
	char set;


#if 0
	printf("conducting test: checking for 0xffffffff\n");
	
	for (; pop->code != NULL; pop++) {
		if (strlen(pop->code) != strlen(pop->mask)) {
			fprintf(stderr, "error entry %d\n", i);	
			exit(1);
		}

		if (strlen(pop->mask) != pop->masklen) {
			fprintf(stderr, "error entry %d - masklen\n", i);	
			exit(1);
		}

		if (strcmp(hex(pop->code), "FFFFFFFF") != 0) {
			fprintf(stderr, "error in test %x\n", atoi(hex(pop->code)));	
			exit(1);
		}
	}
#endif

	SLIST_INIT(&maskhead);

	pop = SET_OP_CODES(rv32, I);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv32, M);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv32, A);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv32, F);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv32, D);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, I);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, M);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, A);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, F);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, D);
	GATHER_OPMASKS();
	pop = SET_OP_CODES(rv64, Q);
	GATHER_OPMASKS();
	
	j = 0;
	SLIST_FOREACH(np, &maskhead, entries) {
		printf("#define %s 0x%s\t/* %s */\n", MASK(j), hex(np->mask), np->mask);
		j++;
	}

	printf("struct rv64_op {\n");	
	printf("\tchar *opcode;\n\tchar *val;\n\tchar *mask\n} rv64_opcodes[] = {\n");
	pop = SET_OP_CODES(rv32, I);
	set = 'I';
	OP_CODES();

	pop = SET_OP_CODES(rv32, M);
	set = 'M';
	OP_CODES();

	pop = SET_OP_CODES(rv32, A);
	set = 'A';
	OP_CODES();

	pop = SET_OP_CODES(rv32, F);
	set = 'F';
	OP_CODES();

	pop = SET_OP_CODES(rv32, D);
	set = 'D';
	OP_CODES();

	pop = SET_OP_CODES(rv64, I);
	set = 'I';
	OP_CODES();
	
	pop = SET_OP_CODES(rv64, M);
	set = 'M';
	OP_CODES();

	pop = SET_OP_CODES(rv64, A);
	set = 'A';
	OP_CODES();

	pop = SET_OP_CODES(rv64, F);
	set = 'F';
	OP_CODES();

	pop = SET_OP_CODES(rv64, D);
	set = 'D';
	OP_CODES();

	pop = SET_OP_CODES(rv64, Q);
	set = 'Q';
	OP_CODES();

	printf("};\n");

	exit(0);
}
